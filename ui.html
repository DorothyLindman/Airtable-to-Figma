<style>
  body {
    font-family: Inter, system-ui, roboto, sans-serif;
    color: #333;
    margin: 0;
    padding: 16px;
    font-size: 11px;
  }
  label {
    display: block;
  }
  h2 {
    font-weight: 600;
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 11px;
  }
  select,
  input {
    font: inherit;
    width: 100%;
    box-sizing: border-box;
    line-height: 16px;
    height: 38px;
    background: white;
    padding: 10px 6px;
    border-radius: 3px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
    outline: none;
    transition: border 300ms;
  }
  select:focus,
  input:focus {
    border-color: #18a0fb;
    transition: none;
  }
  laabel:focus-within h2 {
    color: #18a0fb;
  }

  button {
    padding: 10px 20px;
    border-radius: 3px;
    font: inherit;
    outline: none;
    box-shadow: none;
    border-style: solid;
    border-width: 1px;
  }
  .primary-btn {
    background: #18a0fb;
    color: #fff;
    border-color: #18a0fb;
  }
  .secondary-btn {
    color: #333;
    border-color: rgba(0, 0, 0, 0.1);
  }
  label > .left {
    float: left;
    width: 180px;
    line-height: 38px;
  }
  label > .left + select {
    display: block;
    margin-left: 180px;
    margin-bottom: 5px;
    width: 188px;
  }

  .footer {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 16px;
    display: block;
  }
  ol {
    padding-left: 14px;
  }
  li {
    line-height: 18px;
  }
  svg {
    vertical-align: top;
  }
  .step {
    display: none;
  }
  .step.active {
    display: block;
  }
  .step-msg {
    line-height: 200px;
    text-align: center;
    font-size: 15px;
  }
</style>
<form class="step step-url active">
  <h2 id="log">Get started</h2>
  <ol>
    <li>
      Click
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 16 16"
        class="flex-none"
        style="shape-rendering: geometricprecision;"
      >
        <path
          fill-rule="evenodd"
          class=""
          fill="currentColor"
          d="M4.0338962,12 C4.039975,12 4.04202029,11.999381 4.04264508,12 L4.0338962,12 Z M12,9.5 C12,8.94771525 12.4477153,8.5 13,8.5 C13.5522847,8.5 14,8.94771525 14,9.5 L14,12.0064025 C14,13.0966041 13.1067329,14 12.0088582,14 L4.0338962,14 C2.94133314,14 2.04275439,13.1037881 2.04275439,12.0046024 L2.04275439,3.99539757 C2.04275439,2.90017343 2.94191902,2 4.04394285,2 L6,2 C6.55228475,2 7,2.44771525 7,3 C7,3.55228475 6.55228475,4 6,4 C6,4 4.04275439,4.00424121 4.04275439,3.99539757 C4.04275439,3.99539757 4.04268791,12.0000424 4.04264508,12 C4.04264508,12 12.000729,11.9992535 12,12.0064025 L12,9.5 Z M11.3901883,5.99545798 L8.85626073,8.52938555 C8.38989727,8.99574901 7.63695194,8.99892824 7.16724666,8.52922296 C6.70079341,8.06276971 6.69741624,7.30987673 7.16708407,6.8402089 L9.70101165,4.30628132 L8.8486345,3.45390417 C8.39272337,2.99799304 8.54112219,2.54149221 9.19403103,2.44821952 L12.7417573,1.94140149 C13.3992922,1.84746792 13.8483408,2.30180353 13.7550681,2.95471237 L13.2482501,6.5024386 C13.1543165,7.15997357 12.7047171,7.30998673 12.2425655,6.84783513 L11.3901883,5.99545798 L11.3901883,5.99545798 Z"
        ></path>
      </svg>
      in the Airtable view that contains your data.
    </li>
    <li>Create a shareable grid view link.</li>
    <li id="exampleshr">Copy the link and paste it below.</li>
  </ol>
  <label>
    <h2>Shared view link</h2>
    <input
      id="url"
      type="text"
      placeholder="https://airtable.com/shr..."
      required
    />
  </label>
  <span class="footer">
    <button type="submit" id="load" class="primary-btn">
      Load Airtable data
    </button>
  </span>
</form>
<div class="step step-msg step-loading">
  Reading data from Airtable
</div>
<div class="step step-msg step-empty"></div>
<form class="step step-fields">
  <h2>Columns</h2>
  <div id="fields"></div>
  <span class="footer">
    <button type="submit" id="configure" class="primary-btn">
      Confirm configuration
    </button>
  </span>
</form>
<div class="step step-msg step-select">
  Select a component
</div>
<div class="step step-msg step-texts">
  Selection must contain at least 1 <b>TEXT</b> layer
</div>
<div class="step step-filter">
  <label>
    <h2>Limit</h2>
    <input id="limit" type="number" placeholder="Max row count" />
  </label>
  <label>
    <h2>Filter</h2>
    <input id="app" type="text" placeholder="Example: {Name}='Figma'" />
  </label>
</div>
<script>
  //<button id="debug" lass="secondary-btn">Debug</button>
  let data = {}
  let selection, texts
  document.querySelector('.step-url').onsubmit = async evt => {
    evt.preventDefault()
    toStep('loading')

    const d = await scrape(value('#url'))
    data = d.data
    console.log('data', data)
    rows = data.rows.map(row => {
      const out = {}
      data.columns.forEach(col => {
        out[col.name] = row.cellValuesByColumnId[col.id] || ''
      })
      return out
    })
    toStep('empty')

    await syncSelection()
    if (!selection || !selection.length) {
      return msg('select', 'url')
    }
    if (!texts || !texts.length) {
      return msg('texts', 'url')
    }

    const options = data.columns
      .map(col => `<option>${col.name}</option>`)
      .join('')
    document.querySelector('#fields').innerHTML = texts
      .map(
        text =>
          `<label><div class="left">${text.name}</div><select><option selected>--- Select an Airtable field ---</option>${options}</select></label>`
      )
      .join('')

    toStep('fields')
  }

  document.querySelector('.step-fields').onsubmit = async evt => {
    evt.preventDefault()
    msg('empty', 'url')
    parent.postMessage(
      { pluginMessage: { type: 'airtable-load', data: rows } },
      '*'
    )
  }

  document.querySelector('#exampleshr').onclick = () => {
    document.querySelector('#url').value =
      'https://airtable.com/shrlFq2jSymesUYW3/tblfPZxMSWxyUUpUY'
  }
  document.querySelector('#log').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'debug' } }, '*')
  }

  /* Boot */

  window.addEventListener('message', evt => {
    if (evt.data.selection) {
      selection = evt.data.selection
    }
    if (evt.data.texts) {
      texts = evt.data.texts
    }
    console.log('selection', evt.data.selection)
  })
  parent.postMessage({ pluginMessage: 'get-selection-texts' }, '*')

  function value(elem) {
    if (typeof elem === 'string') {
      elem = document.querySelector(elem)
    }
    if (elem.tagName === 'SELECT') {
      return elem.options[elem.selectedIndex].value
    }
    if (elem.tagName === 'INPUT') {
      return elem.value
    }
    throw new Error('not implemented')
  }

  function scrape(url) {
    if (ls(url)) {
      return ls(url)
    }
    return fetch(
      'https://airtable-shr.glitch.me/api?' +
        serialize({
          url,
        })
    )
      .then(r => r.json())
      .then(data => {
        ls(url, data)
        return data
      })
  }
  function serialize(obj) {
    const str = []
    for (const p in obj) {
      if (obj.hasOwnProperty(p) && obj[p]) {
        str.push(encodeURIComponent(p) + '=' + encodeURIComponent(obj[p]))
      }
    }
    return str.join('&')
  }
  function ls(key, value) {
    try {
      const storage =
        typeof localStorage !== 'undefined' ? localStorage : figma.clientStorage
      if (typeof value === 'undefined') {
        return JSON.parse(storage[key] || 'null')
      } else {
        storage[key] = JSON.stringify(value)
        return value
      }
    } catch (e) {}
  }

  function msg(id, after) {
    toStep(id)
    setTimeout(() => {
      toStep(after || 'fields')
    }, 3000)
  }

  function toStep(id) {
    const elem = document.querySelector('.step.active')
    elem && elem.classList.remove('active')
    document.querySelector('.step-' + id).classList.add('active')
  }

  function syncSelection() {
    return new Promise(res => {
      parent.postMessage({ pluginMessage: 'get-selection-texts' }, '*')
      setTimeout(res, 200)
    })
  }
</script>
